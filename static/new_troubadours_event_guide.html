<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Troubadour Events with Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            text-align: center;
            margin: 5px 0 10px 0;
        }

        h2 {
            text-align: center;
            font-style: italic;
            color: #898b89;
            margin: 5px 0 20px 0;
            font-size: 18px;
        }

        .layout-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .layout-container {
                grid-template-columns: 1fr;
            }
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button.active {
            background-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.3);
        }

        .date-inputs {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 10px;
            align-items: center;
        }

        input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s;
        }

        #map-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 600px;
        }

        #map {
            height: 100%;
            border-radius: 4px;
        }

        .events-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .event {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .event:hover {
            background-color: #f0f0f0;
        }

        .event.special {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            border: 2px solid #2e7d32;
            color: white;
        }

        .event.music {
            background: linear-gradient(135deg, #443cd7 0%, #8e9df3 100%);
            border: 2px solid #1006c6;
            color: white;
        }

        .event.highlighted {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            border-left-width: 8px;
        }

        .event-name {
            font-weight: bold;
            font-size: 16px;
        }

        .event-date {
            margin-top: 5px;
        }


        .event-location {
            color: #c8e6c9;
            font-style: italic;
            margin-top: 3px;
            font-size: 14px;
        }

        .event.hidden {
            display: none;
        }

        .event-facebook {
            display: inline-block;
            margin-left: 10px;
            text-decoration: none !important;
            vertical-align: middle;
            border: none;
            border-bottom: none !important;
        }

        .event-facebook svg {
            width: 20px;
            height: 20px;
            fill: #1877f2;
            transition: fill 0.3s;
        }

        .event-facebook:hover svg {
            fill: #145dbf;
        }


        .event-facebook-inline {
            display: inline-flex;
            text-decoration: none !important;
            border: none !important;
            border-bottom: none !important;
            vertical-align: middle;
        }

        .event-facebook-inline svg {
            width: 20px;
            height: 20px;
            fill: #1877f2;
            transition: fill 0.3s;
        }

        .event-facebook-inline:hover svg {
            fill: #145dbf;
        }


        /* SPECIAL event override ‚Äî white circle, blue F */
        .event-facebook-inline svg {
            fill: #ffffff;
            /* make whole shape white */
        }

        /* SPECIAL event + hover (if you want the F to stay blue on hover) */
        .event-facebook-inline:hover svg {
            fill: #ffffff;
        }

        /* Then recolor only the F using stroke */
        .event-facebook-inline svg path {
            stroke: #1877f2;
            /* FB blue outline = F shape */
            stroke-width: 2px;
            /* adjust until the ‚ÄúF‚Äù looks right */
            stroke-linejoin: round;
        }

        .event-tickets {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-tickets a {
            color: #2e7d32;
            text-decoration: none;
            font-weight: bold;
            border-bottom: 2px solid #4CAF50;
        }

        .event-tickets a {
            color: #ffeb3b;
            border-bottom: 2px solid #fff59d;
        }

        .event-tickets a:hover {
            border-bottom-color: #ffffff;
        }

        .search-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        #searchInput {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-row label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .no-events {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .leaflet-popup-content {
            margin: 10px;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }

        .popup-content p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .button-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            button {
                padding: 8px 6px;
                font-size: 11px;
            }

            .date-inputs {
                grid-template-columns: auto 1fr;
                gap: 8px;
            }
        }

        event-expand-btn {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    background: #4CAF50;
    color: white;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    transition: background 0.3s;
    vertical-align: middle;
}

.event-expand-btn:hover {
    background: #45a049;
}

.event.special .event-expand-btn,
.event.music .event-expand-btn {
    background: rgba(255, 255, 255, 0.3);
}

.event.special .event-expand-btn:hover,
.event.music .event-expand-btn:hover {
    background: rgba(255, 255, 255, 0.5);
}

.event-expandable {
    margin-top: 10px;
    padding: 15px;
    background-color: #ffffff;
    border-left: 4px solid #4CAF50;
    border-radius: 4px;
    margin-bottom: 10px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.event-description {
    margin-bottom: 15px;
    color: #333;
    line-height: 1.6;
}

.event-description p {
    margin: 0 0 10px 0;
}

.event-flyer-image {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
    </style>
</head>

<body>
    <h1>The New Troubadours ‚Äî Storytelling, Music and Punk Poet Events Calendar (UK)</h1>
    <h2>Appropriate all ages, aimed at adults.</h2>

    <div class="controls">
        <div class="button-group">
            <button id="lastWeekBtn" onclick="showWeek(-1)">Last Week</button>
            <button id="thisWeekBtn" onclick="showThisWeek()">This Week</button>
            <button id="nextWeekBtn" onclick="showWeek()">Next Week</button>
            <button id="afterThatWeekBtn" onclick="showWeek(2)">Week After</button>
            <button id="andAnotherWeekBtn" onclick="showWeek(3)">And Another</button>
        </div>
        <div class="date-inputs">
            <label>From:</label>
            <input type="date" id="startDate" onchange="handleStartDateChange()">
            <label>To:</label>
            <input type="date" id="endDate" onchange="handleEndDateChange()">
            <button id="showBtn" onclick="showDateRange()">Show Events</button>
        </div>

        <div class="search-controls">
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="Search events..." onkeyup="filterEvents()">
                <button onclick="clearSearch()">Clear</button>
            </div>
            <div class="filter-row">
                <label>
                    <input type="checkbox" checked id="storyclubsOn" onchange="filterEvents()">
                    Story clubs
                </label>
                <label>
                    <input type="checkbox" checked id="specialOn" onchange="filterEvents()">
                    Story shows
                </label>
                <label>
                    <input type="checkbox" id="showMusic" onchange="filterEvents()">
                    Music events
                </label>
            </div>
        </div>
    </div>

<div
    style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
    <label style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="pinMapView" onchange="togglePinMapView()">
        <span>Pin current map view (don't auto-zoom when changing dates)</span>
    </label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <button onclick="copyShareableLink()" style="background-color: #2196F3;">
            üìã Copy Shareable Link
        </button>
        <span id="copyFeedback" style="color: #4CAF50; font-size: 14px; display: none;">‚úì Link copied!</span>
    </div>
</div>

    <div class="layout-container">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div class="events-list" id="eventsList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let allEventsData = [];
        let geocodeQueue = [];
        let isGeocoding = false;
        let eventsData = null;

        let mapViewPinned = false;
        let pinnedMapView = null;

        // Load events from JSON file
        async function loadEventsData() {
            try {
                const response = await fetch('events_combined.json');
                if (response.ok) {
                    eventsData = await response.json();
                    console.log(`‚úì Loaded events from JSON:`);
                    console.log(`  - ${eventsData.events?.length || 0} recurring events`);
                    console.log(`  - ${eventsData.specificEvents?.length || 0} specific events`);
                    console.log(`  - ${eventsData.musicEvents?.length || 0} music events`);

                    // Flag events with missing geocode
                    const checkMissing = (eventsList, label) => {
                        const missing = eventsList?.filter(e => e.geocode_missing) || [];
                        if (missing.length > 0) {
                            console.warn(`‚ö† ${missing.length} ${label} missing geocode data:`);
                            missing.forEach(e => console.warn(`  - ${e.name}: ${e.location}`));
                        }
                    };

                    checkMissing(eventsData.events, 'recurring events');
                    checkMissing(eventsData.specificEvents, 'specific events');
                    checkMissing(eventsData.musicEvents, 'music events');

                    return eventsData;
                } else {
                    console.error('Failed to load events_combined.json');
                    return null;
                }
            } catch (error) {
                console.error('Error loading events:', error);
                return null;
            }
        }

        function initMap() {
            map = L.map('map').setView([53.0, -2.0], 6); // Center on UK

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            map.on('moveend', updateMapView);
        }

        // Rate-limited geocoding function (fallback only - most coords in JSON)
        async function geocodeLocation(location) {
            // This is now just a fallback for events without latlon in the JSON
            console.warn(`No latlon data for: ${location} - would need API geocoding`);
            return null;
        }

        function parseSchedule(schedule, startDate, endDate) {
            const results = [];
            if (schedule.includes('/')) {
                const [day, month, year] = schedule.split('/').map(num => parseInt(num, 10));
                const specificDate = new Date(year, month - 1, day);
                if (specificDate >= startDate && specificDate <= endDate) {
                    results.push(specificDate);
                }
                return results;
            }

            const [occurrence, dayName] = schedule.toLowerCase().split(/\s+/);
            const dayMap = { sunday: 0, monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5, saturday: 6 };
            const targetDay = dayMap[dayName];

            const current = new Date(startDate.getFullYear(), startDate.getMonth() - 1, 1);
            const extendedEnd = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);

            while (current <= extendedEnd) {
                const year = current.getFullYear();
                const month = current.getMonth();
                const lastDay = new Date(year, month + 1, 0);

                let eventDate = null;

                if (occurrence === 'last') {
                    for (let d = lastDay.getDate(); d >= 1; d--) {
                        const testDate = new Date(year, month, d);
                        if (testDate.getDay() === targetDay) {
                            eventDate = testDate;
                            break;
                        }
                    }
                } else {
                    const occurrenceNum = occurrence === '1st' ? 1 : occurrence === '2nd' ? 2 : occurrence === '3rd' ? 3 : 4;
                    let count = 0;
                    for (let d = 1; d <= lastDay.getDate(); d++) {
                        const testDate = new Date(year, month, d);
                        if (testDate.getDay() === targetDay) {
                            count++;
                            if (count === occurrenceNum) {
                                eventDate = testDate;
                                break;
                            }
                        }
                    }
                }

                if (eventDate && eventDate >= startDate && eventDate <= endDate) {
                    results.push(eventDate);
                }

                current.setMonth(current.getMonth() + 1);
            }

            return results;
        }

        async function displayEvents(startDate, endDate) {
            if (!eventsData) {
                console.error('Events data not loaded');
                return;
            }

            const eventsList = document.getElementById('eventsList');
            allEventsData = [];

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Process recurring events
            for (const event of eventsData.events || []) {
                const dates = parseSchedule(event.schedule, startDate, endDate);
                for (const date of dates) {
                    const eventData = {
                        name: event.name,
                        date: date,
                        time: event.time || null,
                        location: event.location,
                        club: event.club,
                        schedule: event.schedule || null,
                        latlon: event.latlon || null,
                        venue_url: event.venue_url || null,
                        isStoryclub: true,
                        isSpecial: false,
                        isMusic: false
                    };
                    allEventsData.push(eventData);
                    await addMarkerForEvent(eventData);
                }
            }

            // Process specific events
            for (const event of eventsData.specificEvents || []) {
                if (!event.date) {
                    console.warn('Specific event missing date:', event);
                    continue;
                }

                const dateParts = event.date.split('/');
                if (dateParts.length !== 3) {
                    console.warn('Invalid date format for event:', event);
                    continue;
                }

                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10);
                const year = parseInt(dateParts[2], 10);

                const eventDate = new Date(year, month - 1, day);
                if (eventDate >= startDate && eventDate <= endDate) {
                    const eventData = {
                        name: event.name,
                        date: eventDate,
                        time: event.time || null,
                        location: event.location,
                        performer: event.performer,
                        description: event.description || null,
                        event_flyer: event.event_flyer || null,
                        latlon: event.latlon || null,
                        fb_event: event.fb_event || null,
                        ticket_url: event.ticket_url || null,
                        venue_url: event.venue_url || null,
                        isStoryclub: false,
                        isSpecial: true,  // All specificEvents are special events
                        isMusic: false
                    };
                    allEventsData.push(eventData);
                    await addMarkerForEvent(eventData);
                }
            }

            // Process music events
            for (const event of eventsData.musicEvents || []) {
                if (!event.date) {
                    console.warn('Music event missing date:', event);
                    continue;
                }

                const dateParts = event.date.split('/');
                if (dateParts.length !== 3) {
                    console.warn('Invalid date format for music event:', event);
                    continue;
                }

                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10);
                const year = parseInt(dateParts[2], 10);

                const eventDate = new Date(year, month - 1, day);
                if (eventDate >= startDate && eventDate <= endDate) {
                    const eventData = {
                        name: event.name,
                        date: eventDate,
                        time: event.time || null,
                        location: event.location,
                        performer: event.performer,
                        description: event.description || null,
                        event_flyer: event.event_flyer || null,
                        fb_event: event.fb_event || null,
                        ticket_url: event.ticket_url || null,
                        latlon: event.latlon || null,
                        venue_url: event.venue_url || null,
                        isStoryclub: false,
                        isSpecial: false,
                        isMusic: true  // All musicEvents are music
                    };
                    allEventsData.push(eventData);
                    await addMarkerForEvent(eventData);
                }
            }

            allEventsData.sort((a, b) => a.date - b.date);
            renderEventsList(allEventsData);
            // Zoom map to fit all events
            fitMapToEvents();
        }

    function togglePinMapView() {
        mapViewPinned = document.getElementById('pinMapView').checked;

        if (mapViewPinned) {
            // Save current map view
            pinnedMapView = {
                center: map.getCenter(),
                zoom: map.getZoom()
            };
            console.log('Map view pinned:', pinnedMapView);
        } else {
            pinnedMapView = null;
            console.log('Map view unpinned - fitting to current events');
            // When unpinning, immediately fit to current events
            fitMapToEvents();
        }
    }

    function fitMapToEvents() {
            // If map view is pinned, don't auto-zoom
            if (mapViewPinned && pinnedMapView) {
                map.setView(pinnedMapView.center, pinnedMapView.zoom);
                return;
            }

            // Get all events with valid coordinates
            const eventsWithCoords = allEventsData.filter(event => event.coords);

            if (eventsWithCoords.length === 0) {
                // No events with coordinates, zoom to UK
                map.setView([53.0, -2.0], 6);
                return;
            }

            if (eventsWithCoords.length === 1) {
                // Only one event, zoom to it
                const event = eventsWithCoords[0];
                map.setView([event.coords.lat, event.coords.lon], 12);
                return;
            }

            // Multiple events - fit bounds to show all
            const bounds = L.latLngBounds(
                eventsWithCoords.map(event => [event.coords.lat, event.coords.lon])
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        async function addMarkerForEvent(eventData) {
            // Check if latlon is provided directly
            let coords;
            if (eventData.latlon && Array.isArray(eventData.latlon) && eventData.latlon.length === 2) {
                coords = { lat: eventData.latlon[0], lon: eventData.latlon[1] };
            } else {
                // No coordinates available - skip this event
                console.warn(`No coordinates for event: ${eventData.name} at ${eventData.location}`);
                return;
            }

            if (coords) {
                eventData.coords = coords;

                // Color coding: grey for story clubs, green for special events, blue for music
                const markerColor = eventData.isMusic ? '#443cd7' :
                    eventData.isSpecial ? '#4CAF50' :
                        '#808080'; // grey for regular story clubs

                const marker = L.circleMarker([coords.lat, coords.lon], {
                    radius: 8,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `
                    <div class="popup-content">
                        <h3>${eventData.name}</h3>
                        <p><strong>${formatDate(eventData.date)}</strong></p>
                        <p>${eventData.location}</p>
                        ${eventData.performer ? `<p><em>${eventData.performer}</em></p>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.eventData = eventData;

                marker.on('click', () => {
                    highlightEvent(eventData);
                });

                markers.push(marker);
            }
        }

        function updateMapView() {
            // Filter events by map bounds
            const bounds = map.getBounds();
            const visibleEvents = allEventsData.filter(event => {
                if (!event.coords) return false;
                return bounds.contains([event.coords.lat, event.coords.lon]);
            });

            console.log(`Events in map view: ${visibleEvents.length} of ${allEventsData.length}`);
            renderEventsList(visibleEvents);
        }

        function toggleEventExpandable(eventId, event) {
                event.stopPropagation(); // Prevent map zoom when clicking the button
                const expandable = document.getElementById(eventId);
                if (expandable) {
                    if (expandable.style.display === 'none') {
                        expandable.style.display = 'block';
                    } else {
                        expandable.style.display = 'none';
                    }
                }
            }

    function renderEventsList(eventsToShow) {
        const eventsList = document.getElementById('eventsList');
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        if (eventsToShow.length === 0) {
            eventsList.innerHTML = '<div class="no-events">No events in this view</div>';
            return;
        }

        console.log(`Rendering ${eventsToShow.length} events`);

        eventsList.innerHTML = eventsToShow.map(event => {
            const dayName = daysOfWeek[event.date.getDay()];
            const day = event.date.getDate();
            const month = months[event.date.getMonth()];
            const year = event.date.getFullYear();
            const scheduleText = event.schedule ? ` (${event.schedule})` : '';

            const storyclubClass = event.isStoryclub ? ' storyclub' : '';
            const specialClass = event.isSpecial ? ' special' : '';
            const musicClass = event.isMusic ? ' music' : '';

            // Build the tickets/event line for special events
            let ticketsEventLine = '';
            if ((event.isSpecial) || (event.isMusic)) {
                let fbEventIcon = '';
                if (event.fb_event) {
                    const fbEventUrl = `https://www.facebook.com/events/${event.fb_event}`;
                    fbEventIcon = `<a href="${fbEventUrl}" target="_blank" class="event-facebook-inline" title="Facebook Event"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>`;
                }

                let ticketText = '';
                if (event.ticket_url && event.ticket_url.trim()) {
                    ticketText = `<a href="${event.ticket_url}" target="_blank">Tickets available here</a>`;
                }

                // Combine with separator if both exist
                if (fbEventIcon && ticketText) {
                    ticketsEventLine = `<div class="event-tickets">${ticketText} <span class="separator">|</span> ${fbEventIcon}</div>`;
                } else if (fbEventIcon || ticketText) {
                    ticketsEventLine = `<div class="event-tickets">${fbEventIcon}${ticketText}</div>`;
                }
            }

            // Process location with venue link if available
            let locationText = '';
            if (event.location) {
                let locationDisplay = event.location;
                if (event.venue_url && event.venue_url.trim()) {
                    // Extract venue name (text before first comma, or entire location if no comma)
                    const commaIndex = event.location.indexOf(',');
                    const venueName = commaIndex > 0 ? event.location.substring(0, commaIndex) : event.location;
                    const restOfLocation = commaIndex > 0 ? event.location.substring(commaIndex) : '';
                    locationDisplay = `<a href="${event.venue_url}" target="_blank" style="text-decoration: none; color: inherit;"><strong>${venueName}</strong></a>${restOfLocation}`;

                }
                locationText = `<div class="event-location">${locationDisplay}</div>`;
            }

            // Check if there's expandable content (flyer or description)
            const hasExpandableContent = (event.event_flyer && event.event_flyer.trim()) ||
                (event.description && event.description.trim());

            const expandableId = hasExpandableContent ? `event-expand-${Math.random().toString(36).substr(2, 9)}` : '';

            let expandButton = '';
            let expandableContent = '';

            if (hasExpandableContent) {
                expandButton = ` <span class="event-expand-btn" onclick="toggleEventExpandable('${expandableId}', event)">[More info...]</span>`;

                let flyerHtml = '';
                if (event.event_flyer && event.event_flyer.trim()) {
                    flyerHtml = `<img src="./storyclub_assets/event_flyers/${event.event_flyer}" alt="${event.name} flyer" class="event-flyer-image">`;
                }

                let descriptionHtml = '';
                if (event.description && event.description.trim()) {
                    const paragraphs = event.description.split('\n\n\n\n').map(p =>
                        p.trim() ? `<p>${p.replace(/\n\n/g, '<br>')}</p>` : ''
                    ).join('');
                    descriptionHtml = `<div class="event-description">${paragraphs}</div>`;
                }

                expandableContent = `
                <div class="event-expandable" id="${expandableId}" style="display: none;">
                    ${descriptionHtml}
                    ${flyerHtml}
                </div>
            `;
            }

            return `
            <div class="event${storyclubClass}${specialClass}${musicClass}" 
                 onclick="zoomToEvent(${event.coords?.lat}, ${event.coords?.lon})"
                 data-event-id="${event.name}-${event.date.getTime()}">
                <div class="event-name">${event.name}${expandButton}</div>
                ${event.performer ? `<div style="font-style: italic;">${event.performer}</div>` : ''}
                ${locationText}
                <div class="event-date">${dayName}, ${day} ${month} ${year}${scheduleText}${event.time ? `, ${event.time}` : ''}</div>
                ${ticketsEventLine}
            </div>
            ${expandableContent}
        `;
        }).join('');

        filterEvents();
    }

        function zoomToEvent(lat, lon) {
            if (lat && lon) {
                map.setView([lat, lon], 13);
            }
        }

        function highlightEvent(eventData) {
            const eventId = `${eventData.name}-${eventData.date.getTime()}`;
            document.querySelectorAll('.event').forEach(el => el.classList.remove('highlighted'));
            const eventEl = document.querySelector(`[data-event-id="${eventId}"]`);
            if (eventEl) {
                eventEl.classList.add('highlighted');
                eventEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function formatDate(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function filterEvents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const specialOn = document.getElementById('specialOn').checked;
            const storyclubsOn = document.getElementById('storyclubsOn').checked;
            const showMusic = document.getElementById('showMusic').checked;

            console.log('Filter settings:', { specialOn, storyclubsOn, showMusic });

            // Filter event list items
            const allEventElements = document.querySelectorAll('.event');
            console.log(`Total event elements: ${allEventElements.length}`);

            allEventElements.forEach(event => {
                let visible = false;

                const isStoryclub = event.classList.contains('storyclub');
                const isSpecial = event.classList.contains('special');
                const isMusic = event.classList.contains('music');

                // Show event if its type checkbox is checked
                if (storyclubsOn && isStoryclub) visible = true;
                if (specialOn && isSpecial) visible = true;
                if (showMusic && isMusic) visible = true;

                // Apply search filter if search term exists
                if (visible && searchTerm) {
                    const text = event.textContent.toLowerCase();
                    visible = text.includes(searchTerm);
                }

                event.classList.toggle('hidden', !visible);
            });

            // Filter map markers
            markers.forEach(marker => {
                const eventData = marker.eventData;
                let visible = false;

                if (storyclubsOn && eventData.isStoryclub) visible = true;
                if (specialOn && eventData.isSpecial) visible = true;
                if (showMusic && eventData.isMusic) visible = true;

                // Apply search filter if search term exists
                if (visible && searchTerm) {
                    const searchableText = `${eventData.name} ${eventData.location} ${eventData.performer || ''}`.toLowerCase();
                    visible = searchableText.includes(searchTerm);
                }

                // Show/hide marker based on filter
                if (visible) {
                    marker.setStyle({ opacity: 1, fillOpacity: 0.8 });
                } else {
                    marker.setStyle({ opacity: 0, fillOpacity: 0 });
                }
            });

            // Count visible events
            const visibleCount = document.querySelectorAll('.event:not(.hidden)').length;
            console.log(`Visible events after filtering: ${visibleCount}`);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterEvents();
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekEnd(weekStart) {
            const end = new Date(weekStart);
            end.setDate(end.getDate() + 6);
            return end;
        }

        function setActiveMode(mode) {
            document.querySelectorAll('.button-group button').forEach(btn => btn.classList.remove('active'));
            if (mode === 'thisWeek') document.getElementById('thisWeekBtn').classList.add('active');
            else if (mode === 'nextWeek1') document.getElementById('nextWeekBtn').classList.add('active');
            else if (mode === 'nextWeek2') document.getElementById('afterThatWeekBtn').classList.add('active');
            else if (mode === 'nextWeek3') document.getElementById('andAnotherWeekBtn').classList.add('active');
            else if (mode === 'lastWeek1') document.getElementById('lastWeekBtn').classList.add('active');
        }

        function updateDateInputs(startDate, endDate) {
                // Format dates as YYYY-MM-DD for the date inputs
                const formatForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                document.getElementById('startDate').value = formatForInput(startDate);
                document.getElementById('endDate').value = formatForInput(endDate);
            }

        function showThisWeek() {
            const today = new Date();
            const weekStart = getWeekStart(today);
            const weekEnd = getWeekEnd(weekStart);
            updateDateInputs(weekStart, weekEnd); 
            displayEvents(weekStart, weekEnd);
            setActiveMode('thisWeek');
        }

        function showWeek(weeksAhead = 1) {
            const today = new Date();
            const thisWeekStart = getWeekStart(today);
            const targetWeekStart = new Date(thisWeekStart);
            targetWeekStart.setDate(targetWeekStart.getDate() + (7 * weeksAhead));
            const targetWeekEnd = getWeekEnd(targetWeekStart);
            updateDateInputs(targetWeekStart, targetWeekEnd);
            displayEvents(targetWeekStart, targetWeekEnd);
            setActiveMode(weeksAhead > 0 ? `nextWeek${weeksAhead}` : `lastWeek${Math.abs(weeksAhead)}`);
        }

    function showDateRange(clearActiveButton = true) {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;

        if (!startInput) {
            alert('Please select at least a start date');
            return;
        }

        const startDate = new Date(startInput);
        const endDate = endInput ? new Date(endInput) : getWeekEnd(getWeekStart(startDate));
        displayEvents(startDate, endDate);

        // Only clear active button styling when manually using custom date range
        if (clearActiveButton) {
            document.querySelectorAll('.button-group button').forEach(btn => btn.classList.remove('active'));
        }
    }
    let lastStartDate = '';
    let lastEndDate = '';

    function handleStartDateChange() {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;

        if (startInput && endInput) {
            const [startYear, startMonth, startDay] = startInput.split('-').map(Number);
            const [endYear, endMonth, endDay] = endInput.split('-').map(Number);

            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);

            // Start date changed - if it's now after end date, adjust end to end of start's week
            if (startDate > endDate) {
                const weekEnd = getWeekEnd(getWeekStart(startDate));
                document.getElementById('endDate').value = formatDateForInput(weekEnd);
            }
        }

        if (startInput) {
            showDateRange(true);
        }
    }

    function handleEndDateChange() {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;

        if (startInput && endInput) {
            const [startYear, startMonth, startDay] = startInput.split('-').map(Number);
            const [endYear, endMonth, endDay] = endInput.split('-').map(Number);

            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);

            // End date changed - if it's now before start date, adjust start to beginning of end's week
            if (endDate < startDate) {
                const weekStart = getWeekStart(endDate);
                document.getElementById('startDate').value = formatDateForInput(weekStart);
            }
        }

        if (startInput) {
            showDateRange(true);
        }
    }

 function generateShareableURL(startDate, endDate) {
        const formatForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const params = new URLSearchParams();
        params.set('start', formatForInput(startDate));
        params.set('end', formatForInput(endDate));

        // Add filter states
        params.set('storyclubs', document.getElementById('storyclubsOn').checked ? '1' : '0');
        params.set('special', document.getElementById('specialOn').checked ? '1' : '0');
        params.set('music', document.getElementById('showMusic').checked ? '1' : '0');

        return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
    }

        async function copyShareableLink() {
            const startInput = document.getElementById('startDate').value;
            const endInput = document.getElementById('endDate').value;

            if (!startInput) {
                alert('Please select a date range first');
                return;
            }

            const startDate = new Date(startInput);
            const endDate = endInput ? new Date(endInput) : getWeekEnd(getWeekStart(startDate));

            const shareableURL = generateShareableURL(startDate, endDate);

            try {
                await navigator.clipboard.writeText(shareableURL);
                const feedback = document.getElementById('copyFeedback');
                feedback.style.display = 'inline';
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const tempInput = document.createElement('input');
                tempInput.value = shareableURL;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                const feedback = document.getElementById('copyFeedback');
                feedback.style.display = 'inline';
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 2000);
            }
        }

        function getURLParams() {
                const params = new URLSearchParams(window.location.search);
                const start = params.get('start');
                const end = params.get('end');

                if (start) {
                    const storyclubs = params.get('storyclubs') === '1';
                    const special = params.get('special') === '1';
                    const music = params.get('music') === '1';

                    // If none are selected, default storyclubs and special to true
                    const noneSelected = !storyclubs && !special && !music;

                    return {
                        startDate: new Date(start),
                        endDate: end ? new Date(end) : null,
                        storyclubs: noneSelected ? true : storyclubs,
                        special: noneSelected ? true : special,
                        music: music
                    };
                }
                return null;
            }

        // Initialize
        window.addEventListener('load', async () => {
                await loadEventsData();
                initMap();

                // Check for URL parameters first
                const urlParams = getURLParams();
            if (urlParams) {
                const startDate = urlParams.startDate;
                const endDate = urlParams.endDate || getWeekEnd(getWeekStart(startDate));

                // Apply filter settings from URL
                document.getElementById('storyclubsOn').checked = urlParams.storyclubs;
                document.getElementById('specialOn').checked = urlParams.special;
                document.getElementById('showMusic').checked = urlParams.music;

                updateDateInputs(startDate, endDate);
                await displayEvents(startDate, endDate);
            } else {
                showThisWeek();
            }
            });
    </script>
</body>

</html>